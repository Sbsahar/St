import os
import threading
import tempfile
import requests
from telethon import TelegramClient, events
import asyncio
from ste import bot, check_image_safety, send_violation_report, n2, TOKEN

# Ø¨ÙŠØ§Ù†Ø§Øª Telethon
API_ID = 21290600  # Ø¶Ø¹ API_ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
API_HASH = "2bd56b3e7715ec5862d6f856047caa95"  # Ø¶Ø¹ API_HASH Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ Telethon Ù„Ù„Ø¨ÙˆØª
client = TelegramClient('edited_monitor', API_ID, API_HASH).start(bot_token=TOKEN)

# Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
@client.on(events.MessageEdited(chats=lambda e: e.is_channel))
async def edited_handler(event):
    """
    Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª.
    Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙŠØ¯ÙŠØ§ (ØµÙˆØ±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆØŒ Ø£Ùˆ Ù…ØªØ­Ø±ÙƒØ©) ÙŠÙ‚ÙˆÙ… Ø¨ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙˆÙØ­ØµÙ‡.
    """
    message = event.message  # Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
    print(f"ğŸ”„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© {message.chat.title}ØŒ ID: {message.id}")

    # ÙØ­Øµ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
    if message.photo:
        file_path = await message.download_media()
        if not file_path:
            return
        try:
            result = check_image_safety(file_path)
            os.remove(file_path)
            if result == 'nude':
                try:
                    bot.delete_message(message.chat_id, message.id)
                    send_violation_report(message.chat_id, message, "âœï¸ ØµÙˆØ±Ø© Ù…Ø¹Ø¯Ù„Ø© ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©")
                    print("âœ… ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ù…Ø¹Ø¯Ù„Ø© ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©")
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©: {e}")
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©: {e}")
    
    # ÙØ­Øµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
    elif message.video:
        file_path = await message.download_media()
        if not file_path:
            return
        try:
            elapsed, nsfw_probs = n2.predict_video_frames(file_path)
            os.remove(file_path)
            if any(prob >= 0.5 for prob in nsfw_probs):
                try:
                    bot.delete_message(message.chat_id, message.id)
                    send_violation_report(message.chat_id, message, "âœï¸ ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹Ø¯Ù„ ØºÙŠØ± Ù„Ø§Ø¦Ù‚")
                    print("âœ… ØªÙ… Ø­Ø°Ù ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹Ø¯Ù„ ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©")
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¹Ø¯Ù„: {e}")
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¹Ø¯Ù„: {e}")
    
    # ÙØ­Øµ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
    elif message.animation:
        file_path = await message.download_media()
        if not file_path:
            return
        try:
            elapsed, nsfw_probs = n2.predict_video_frames(file_path)
            os.remove(file_path)
            if any(prob >= 0.5 for prob in nsfw_probs):
                try:
                    bot.delete_message(message.chat_id, message.id)
                    send_violation_report(message.chat_id, message, "âœï¸ ØµÙˆØ±Ø© Ù…ØªØ­Ø±ÙƒØ© Ù…Ø¹Ø¯Ù„Ø© ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©")
                    print("âœ… ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ù…ØªØ­Ø±ÙƒØ© Ù…Ø¹Ø¯Ù„Ø© ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©")
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©: {e}")
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©: {e}")

# Ø¯Ø§Ù„Ø© Ù„ØªØ´ØºÙŠÙ„ Telethon ÙÙŠ Ø­Ù„Ù‚Ø© asyncio
async def run_telethon():
    await client.run_until_disconnected()

# ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ø®ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
if __name__ == "__main__":
    asyncio.run(run_telethon())
